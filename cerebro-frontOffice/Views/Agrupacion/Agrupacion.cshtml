<script>
    $(document).ready(function () {
        getAgrupacionesByUsuario();
        getUsuariosByMunicipalidad();
        $('.ui.sidebar')
            .sidebar('attach events', '.toc.item')
            .sidebar('setting', 'transition', 'overlay')
            .sidebar('setting', 'dimPage', false);
        $('.ui.dropdown').dropdown();
    });
</script>
<div class="ui sidebar vertical left inverted menu w3-cerebro-blue">
    <div class="w3-center w3-margin-top"><img src="~/images/cerebro.png" style="height: 30px" class="w3-image"></div>
    <div class="ui horizontal divider"></div>
    <div class="w3-center">
        <a href="/inicio/inicio"><i class="home big icon circular link"></i></a>
        @if (User.Identity.IsAuthenticated)
        {
            <h3 class="ui horizontal divider w3-padding header small inverted" style="margin-top: 5px">@User.Claims.ToList()[0].Value</h3>
        }
        else
        {
            <h3 class="ui horizontal divider w3-padding header small inverted" style="margin-top: 5px">Usuario</h3>
        }
        <a class="ui toc item header small" href="/Chat/Chat">Chat</a>
        <a class="ui toc item header small active" href="/Agrupacion/Agrupacion">Agrupaciones</a>
        <a class="ui toc item header small" href="/Simulador/Simulador">Simulador</a>
        <a class="ui toc item header small">Reportes</a>
    </div>
</div>
<div class="pusher" style="background-image: url(~/images/ub1610v2.jpg); background-attachment: fixed; background-repeat: no-repeat;background-size: cover">
    <div class="w3-bar w3-card" style="background-color: #FBFBFB">
        <div class="ui menu secondary" style="background-color: #FBFBFB; padding-bottom: 0px">
            <a class="ui toc item left aligned"><i class="sidebar icon"></i></a>
            <div class="right menu">
                @if (User.Identity.IsAuthenticated)
                {
                    <h4 class="ui item header right aligned">@User.Claims.ToList()[0].Value</h4>
                    <a class="ui item right aligned w3-right" asp-controller="Account" asp-action="Logout"><i class="sign out icon w3-text-cerebro-red"></i></a>
                }
                else
                {
                    <h4 class="ui item header right aligned">Usuario</h4>
                    <a class="ui item right aligned w3-right"><i class="sign out icon w3-text-cerebro-red"></i></a>
                }
            </div>
        </div>
        <div class="w3-center w3-display-topmiddle" style="margin-top: 7px"><img src="~/images/cerebro-logo.png" class="w3-image" style="height: 35px"></div>
        <div class="ui secondary menu w3-light-gray w3-padding">
            <div class="ui breadcrumb item">
                @if (User.Identity.IsAuthenticated)
                {
                    <div class="section"><h4 class="ui header w3-text-cerebro-red">@User.Claims.ToList()[3].Value</h4></div>
                }
                else
                {
                    <div class="section"><h4 class="ui header w3-text-cerebro-red">Municipalidad</h4></div>
                }
                <div class="divider"> <strong>/</strong> </div>
                <div class="active section"><h4 class="ui text header w3-text-silver">Agrupaciones</h4></div>
            </div>
        </div>
    </div>
    <div class="ui grid stackable container w3-padding w3-padding-16">
        <div class="row" id="goyete">
            <div class="ui grid stackable container">
                <div class="sixteen wide column w3-padding-64">
                    <div class="ui segments">
                        <div class="ui grey secondary segment">
                            <div class="ui secondary menu">
                                <select class="ui dropdown" id="agrupacionesList">
                                    <option value="" selected disabled>Seleccione una agrupaci&oacute;n...</option>
                                </select>
                            </div>
                        </div>
                        <div class="ui raised segment" id="fletesContext" style="min-height: 300px">
                            <div class="ui active tab w3-padding">
                                <h4 class="ui horizontal divider text header w3-text-cerebro-red w3-padding">Agrupacion</h4>
                                <select id="usuariosMunicipalidad" class="ui fluid dropdown w3-padding">
                                    <option value="">Seleccione usuarios para agregarlos a la agrupaci&oacute;n...</option>
                                </select>
                                <table class="ui compact celled grey table">
                                    <thead>
                                        <tr>
                                            <th>esAdmin</th>
                                            <th>Nombre</th>
                                            <th>E-mail</th>
                                            <th style="width: 10%">Acci&oacute;n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="collapsing">
                                                <div class="ui fitted slider checkbox">
                                                    <input type="checkbox"> <label></label>
                                                </div>
                                            </td>
                                            <td>John Lilki</td>
                                            <td>jhlilk22@yahoo.com</td>
                                            <td class="w3-center"><i class="ui remove user icon link"></i></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="ui right aligned grey secondary segment">
                            <h4 class="ui horizontal divider text header w3-text-cerebro-red small w3-padding">Crear agrupacion</h4>
                            <div class="ui text container">
                                <div class="ui action input fluid small">
                                    <input id="nombre" placeholder="Nombre de la agrupaci&oacute;n a crear..." type="text">
                                    <button class="ui button w3-cerebro-blue" onclick="addAgrupacion()">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var email = '@User.Claims.ToList()[0].Value';
	var municipalidad = '@User.Claims.ToList()[3].Value';
    function getAgrupacionesByUsuario() {
        if (email !== ""){ 
            $.get("https://www.cerebro-serviceLayer.com/api/agrupaciones/byUsuario?usuario_email=" + email, function (response) {
                if (response !== undefined) { 
                    while (document.getElementById("agrupacionesList").hasChildNodes()) {
                        document.getElementById("agrupacionesList").removeChild(document.getElementById("agrupacionesList").lastChild);
                    }
                    $.each(response, function (index, agrupacion) {
                        var option = document.createElement("option");
                        option.value = agrupacion;
                        option.innerHTML = agrupacion;
                        document.getElementById("agrupacionesList").appendChild(option);
                    });
                }
            });
        }
	}
	function addAgrupacion() {
		"use strict";
		var agrupacion = document.getElementById("nombre").value;
		var postInfo = "nombre_agrupacion=" + agrupacion + "&nombre_municipalidad_agrupacion=" + municipalidad + "&usuario_email=" + email + "&nombre_municipalidad_usuario=" + municipalidad + "&admin=true";
		if (agrupacion !== "") {
			$.post("https://www.cerebro-serviceLayer.com/api/agrupaciones", postInfo, function(response){
				if(response === true){
					alert("agrupacion creada");
				}
				else{
					alert("agrupacion no creada");
				}
			});
		}
    }
    function deleteAgrupacion(nombre) {
        if (nombre !== "" && municipalidad !== "") { 
            var deleteInfo = "nombre=" + nombre + "&nombre_municipalidad=" + municipalidad;
            $.ajax({
                url: 'https://www.cerebro-serviceLayer.com/api/agrupaciones?' + deleteInfo,
                type: 'DELETE',
                success: function (data) {
                    if (data === true) {
                        alert("agrupacion eliminada");
                    } else {
                        alert("agrupacion no eliminada");
                    }
                }
            });
        }
    }
    function toggleAdminAgrupacion(agrupacion, email, esAdmin) {
        if (agrupacion !== "" && email !== "" && municipalidad !== "") { 
            var postInfo = "nombre_agrupacion=" + agrupacion + "&nombre_municipalidad_agrupacion=" + municipalidad + "&usuario_email=" + email + "&nombre_municipalidad_usuario=" + municipalidad + "&admin=" + esAdmin;
            $.ajax({
                url: 'https://www.cerebro-serviceLayer.com/api/agrupaciones/usuario?' + postInfo,
                type: 'PUT',
                success: function (data) {
                    if (data === true) {
                        alert("admin cambiado");
                    } else {
                        alert("admin no cambiado");
                    }
                }
            });
        }
    }
    function deleteUsuarioAgrupacion(agrupacion, email) {
        if (agrupacion !== "" && email !== "" && municipalidad !== "") { 
            var postInfo = "nombre_agrupacion=" + agrupacion + "&nombre_municipalidad_agrupacion=" + municipalidad + "&usuario_email=" + email + "&nombre_municipalidad_usuario=" + municipalidad;
            $.ajax({
                url: 'https://www.cerebro-serviceLayer.com/api/agrupaciones/usuario?' + postInfo,
                type: 'DELETE',
                success: function (data) {
                    if (data === true) {
                        alert("agrupacion eliminada");
                    } else {
                        alert("agrupacion no eliminada");
                    }
                }
            });
        }
    }
    function getUsuariosByAgrupacion(agrupacion) {
        if (agrupacion !== "") {
            $.get("https://www.cerebro-serviceLayer.com/api/agrupaciones/" + agrupacion, function () { 

            });
        }
    }
    function getUsuariosByMunicipalidad() {
        if (municipalidad !== "") {
            $.get("https://www.cerebro-serviceLayer.com/api/usuarios/municipalidad/" + municipalidad, function (response) {
                if (response !== undefined) {
                    $.each(response, function (index, usuario) {
                        var option = document.createElement("option");
                        option.value = usuario.email;
                        option.innerHTML = usuario.nombre;
                        document.getElementById("usuariosMunicipalidad").appendChild(option);
                    });
                }
            });
        }
    }
</script>
